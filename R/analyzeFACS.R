#---- Header content ----
## @knitr header
library(psych)
library(ggplot2)
#library(BiocInstaller)
#library(ggcyto)
#library(flowCore)
library(outliers)
library(fitdistrplus)
#library(clusterSim)
library(reshape2)
library(readxl)
library(plyr)
library(dplyr)
library(multcomp)
library(plotly)

# source("https://bioconductor.org/biocLite.R")
# biocLite()

# custom function definitions
abcellplot <- function(Vab, Vcell) {
  ggplot(tlog_df[which(tlog_df$antibody == Vab & tlog_df$cellline == Vcell), ], aes(fl, fill = replicate, by = replicate)) +
    geom_density(alpha = alp,  adjust = bw) +
    facet_grid(timepoint ~ dose) +
    geom_vline(aes(xintercept = mean), log_ctrl_means[which(log_ctrl_means$cellline == Vcell &
                                                              log_ctrl_means$antibody == Vab),]) +
    geom_vline(aes(xintercept = mean+sd), log_ctrl_means[which(log_ctrl_means$cellline == Vcell &
                                                                 log_ctrl_means$antibody == Vab),],
               linetype = 2) +
    geom_vline(aes(xintercept = mean-sd), log_ctrl_means[which(log_ctrl_means$cellline == Vcell &
                                                                 log_ctrl_means$antibody == Vab),],
               linetype = 2) +
    ggtitle(paste(Vab, Vcell))
}

tabcellplot <- function(Vab, Vcell) {
  ggplot(tdf[which(tdf$antibody == Vab & tdf$cellline == Vcell), ], aes(fl, fill = replicate, by = replicate)) +
    geom_density(alpha = alp,  adjust = bw) +
    facet_grid(timepoint ~ dose) +
    geom_vline(aes(xintercept = mean), ctrl_means[which(ctrl_means$cellline == Vcell &
                                                              ctrl_means$antibody == Vab),]) +
    geom_vline(aes(xintercept = mean+sd), ctrl_means[which(ctrl_means$cellline == Vcell &
                                                                 ctrl_means$antibody == Vab),],
               linetype = 2) +
    geom_vline(aes(xintercept = mean-sd), ctrl_means[which(ctrl_means$cellline == Vcell &
                                                                 ctrl_means$antibody == Vab),],
               linetype = 2) +
    ggtitle(paste(Vab, Vcell))
}


# plotting preferences
theme_set(theme_bw())
theme_update(plot.title = element_text(hjust = 0.5),
             panel.grid.major = element_blank(),
             panel.grid.minor = element_blank())

alp = 0.5 # set transparency
bw = 0.5 # multiplier for bandwidth relative to defualt (SD)

pfill = 'replicate' # select the fill

# command for bulk renaming within a directory
#for dir in ./*; do (cd "$dir" && bulk_rename _S _B csv); done

setwd('./')

#---- Data import from the listed folders ----
xlfiles <- dir("data/")
xlsheets <- array()
rdata <- list()
data_length <- array()
dataset_name <- list()
k = 0
for (i in seq(length(xlfiles))){
  for (j in seq(length(excel_sheets(paste('data/', xlfiles[i], sep = ''))))){
    rdata[[j+k]] <- data.frame(read_excel(paste('data/', xlfiles[i], sep = ''), sheet = excel_sheets(paste('data/', xlfiles[i], sep = ''))[j]))
    data_length[j+k] <- nrow(rdata[[j+k]])
  }
  k = k + j
}

maxdata <- max(data_length)

i = 1


temp <- data.frame(matrix(nrow = maxdata-nrow(rdata[[i]]), ncol = ncol(rdata[[i]])))
colnames(temp) <- colnames(rdata[[i]])
rdata[[i]] <- rbind(rdata[[i]], temp)

rdata[[i]] <- rbind(rdata[[i]], matrix(nrow = (maxdata - nrow(rdata[[i]])), ncol = ncol(rdata[[i]])))


for (i in seq(length(rdata))){
  temp <- data.frame(matrix(nrow = maxdata-nrow(rdata[[i]]), ncol = ncol(rdata[[i]])))
  colnames(temp) <- colnames(rdata[[i]])
  rdata[[i]] <- rbind(rdata[[i]], temp)
}

alldata <- rdata[[1]]
for (i in seq(length(rdata)-1)){
  alldata <- cbind(alldata, rdata[[i]])
}

timepoint <- array(dim = ncol(alldata))
cellline <- array(dim = ncol(alldata))
antibody <- array(dim = ncol(alldata))
replicate <- array(dim = ncol(alldata))
dose <- array(dim = ncol(alldata))
cellcycle <- array(dim = ncol(alldata))
exposure <- array(dim = ncol(alldata))
control <- array(dim = ncol(alldata))


for (i in seq(ncol(alldata))){
    exposure[i] <- unlist(strsplit(colnames(alldata)[i], split = "_"))[1]
    timepoint[i] <- unlist(strsplit(colnames(alldata)[i], split = "_"))[2]
    cellline[i] <- unlist(strsplit(colnames(alldata)[i], split = "_"))[3]
    antibody[i] <- unlist(strsplit(colnames(alldata)[i], split = "_"))[4]
    replicate[i] <- unlist(strsplit(colnames(alldata)[i], split = "_"))[5]
    dose[i] <- unlist(strsplit(colnames(alldata)[i], split = "_"))[6]
    cellcycle[i] <- unlist(strsplit(colnames(alldata)[i], split = "_"))[7]
}

throwouts <- which(exposure == 'X')
throwouts <- c(throwouts)

exposure <- exposure[-throwouts]
timepoint <- timepoint[-throwouts]
cellline <- cellline[-throwouts]
antibody <- antibody[-throwouts]
replicate <- replicate[-throwouts]
dose <- dose[-throwouts]
cellcycle <- cellcycle[-throwouts]

alldata <- alldata[,-throwouts]



for (i in 1){
  subdata <- data.frame(FL = alldata[,i])
  subdata <- cbind(subdata,
                   Exposure = exposure[i],
                   Timepoint = timepoint[i],
                   Cellline = cellline[i],
                   Antibody = antibody[i],
                   Replicate = replicate[i],
                   Dose = dose[i],
                   Cellcycle = cellcycle[i])
  subdata <-  subdata[-which(is.na(subdata$FL)),]
}

m_alldata <- subdata

levels(m_alldata$Exposure) <- unique(exposure)
levels(m_alldata$Timepoint) <- unique(timepoint)
levels(m_alldata$Cellline) <- unique(cellline)
levels(m_alldata$Antibody) <- unique(antibody)
levels(m_alldata$Replicate) <- unique(replicate)
levels(m_alldata$Dose) <- unique(dose)
levels(m_alldata$Cellcycle) <- unique(cellcycle)


m2_alldata <- list()
m2_alldata[[1]] <- subdata


for (i in seq(ncol(alldata)-1)){
#for (i in seq(401)-1){
  i = i+1
  subdata <- data.frame(FL = alldata[,i])
  subdata <- cbind(subdata,
                   Exposure = exposure[i],
                   Timepoint = timepoint[i],
                   Cellline = cellline[i],
                   Antibody = antibody[i],
                   Replicate = replicate[i],
                   Dose = dose[i],
                   Cellcycle = cellcycle[i])
  if (length(which(is.na(alldata[,i]))) > 0){
    subdata <- subdata[-which(is.na(subdata$FL)),]
  }
  m2_alldata[[i]] <- subdata
}

cellcount <- array(dim = length(m2_alldata))

for (i in seq(length(m2_alldata))){
  cellcount[i] <- nrow(m2_alldata[[i]])
}

addrows <- sum(cellcount) - nrow(m_alldata)

m_alldata <- bind_rows(m_alldata, setNames(data.frame(matrix(nrow = addrows, ncol = ncol(m_alldata))),
                                           colnames(m_alldata)))

for (i in seq(length(m2_alldata)-1)){
  start = sum(cellcount[1:i])+1
  end = start + cellcount[i+1]-1
  m_alldata[start:end, ] <- m2_alldata[[i+1]]
}

levels(m_alldata$Exposure) <- unique(exposure)

log_alldata <- cbind(m_alldata[,-1], FL = log(m_alldata$FL))
sublog <- log_alldata[which(log_alldata$Exposure == 'Fe1000'),]# &
                            #log_alldata$Timepoint == '2h'),]# &
                            # log_alldata$Dose == '0Gy'),]



ggplot(sublog, aes(FL, fill = Dose)) +
  geom_density(alpha = alp, adjust = bw) +
  facet_grid(Antibody~Timepoint)


# normalization by set (medians of control sets)
norms <- merge(log_alldata[], ddply(log_alldata[which(log_alldata$Dose == '0Gy'),],
      .(Exposure, Timepoint, Cellline, Antibody, Replicate, Cellcycle), summarize,
      median = round(median(FL), 3)))

setnormdata <- cbind(norms[,1:7], FL = norms$FL-norms$median+1)

setstats <- ddply(setnormdata, .(Exposure, Timepoint, Cellline, Antibody, Replicate, Cellcycle, Dose), summarize,
      mean = round(mean(FL), 3),
      median = round(median(FL), 3),
      sd = round(sd(FL), 3),
      gmean = round(psych::geometric.mean(FL), 3))



# normalization by Z-score
norms <- merge(log_alldata[], ddply(log_alldata[which(log_alldata$Dose == '0Gy'),],
                                    .(Exposure, Timepoint, Cellline, Antibody, Replicate, Cellcycle), summarize,
                                    mean = round(mean(FL), 3),
                                    sd = round(sd(FL), 3)))

setnormdata <- cbind(norms[,1:7], FL = (norms$FL-norms$mean)/norms$sd)

setstats <- ddply(setnormdata, .(Exposure, Timepoint, Cellline, Antibody, Replicate, Cellcycle, Dose), summarize,
                  mean = round(mean(FL), 3),
                  median = round(median(FL), 3),
                  sd = round(sd(FL), 3),
                  gmean = round(psych::geometric.mean(FL), 3))


for (i in seq(length(unique(exposure)))){
  for (j in seq(length(unique(cellline)))){

    plotdata <- setnormdata[which(setnormdata$Exposure == unique(exposure)[i] &
                                    setnormdata$Cellline == unique(cellline)[j] &
                                    setnormdata$Antibody != unique(antibody)[4]),]
    if (nrow(plotdata) > 10){

      ggplot(plotdata, aes(x = Dose, y = FL)) +
        geom_boxplot(aes(fill = Dose)) +
        geom_hline(yintercept = 1) +
        facet_grid(Antibody~Timepoint) +
        ggtitle(paste(plotdata$Exposure[i],
                      plotdata$Cellline[i],
                      plotdata$Antibody[i],
                      plotdata$Cellcycle[i],
                      'Norm by median',
                      sep = ' ')) +
        ggsave(filename = paste('figures/averaged/boxplots/median_norm/prelim',
                                plotdata$Exposure[i],
                                plotdata$Cellline[i],
                                plotdata$Antibody[i],
                                plotdata$Cellcycle[i],
                                'Norm by set median.pdf',
                                sep = '_'),
               width = 8.5, height = 5.5, units = "in")
    }

    plotdata <- setnormdata[which(setnormdata$Exposure == unique(exposure)[i] &
                                    setnormdata$Cellline == unique(cellline)[j] &
                                    setnormdata$Antibody == unique(antibody)[4]),]
    if (nrow(plotdata) > 10){

      ggplot(plotdata, aes(x = Dose, y = FL)) +
        geom_boxplot(aes(fill = Dose)) +
        geom_hline(yintercept = 1) +
        facet_grid(Antibody~Timepoint) +
        ggtitle(paste(plotdata$Exposure[i],
                      plotdata$Cellline[i],
                      plotdata$Antibody[i],
                      plotdata$Cellcycle[i],
                      'Norm by Z-score',
                      sep = ' ')) +
      ggsave(filename = paste('figures/averaged/boxplots/zscore_norm/prelim',
                       plotdata$Exposure[i],
                       plotdata$Cellline[i],
                       plotdata$Antibody[i],
                       plotdata$Cellcycle[i],
                       'Norm by set Z-score.pdf',
                       sep = '_'),
      width = 8.5, height = 5.5, units = "in")
    }
  }
}





ggplot(setnormdata[which(setnormdata$Exposure == unique(exposure)[3] &
                           setnormdata$Cellline == unique(cellline)[1] &
                           #setnormdata$Timepoint == unique(timepoint)[2] &
                           setnormdata$Antibody != unique(antibody)[4]
                           ),],
       aes(x = Dose, y = FL)) +
  geom_boxplot(aes(fill = Replicate, color = Replicate)) +
  geom_hline(yintercept = 1) +
  facet_grid(Antibody~Timepoint)






# for (i in seq(length(unique(exposure)))){
#
#   plotdata <- setnormdata[which(setnormdata$Exposure == unique(exposure)[i]),]
#
#   ggplot(plotdata, aes(FL, fill = Replicate)) +
#     geom_density(alpha = alp, adjust = bw) +
#     facet_grid(Dose~Timepoint) +
#     geom_vline(xintercept = 1) +
#     ggtitle(paste(plotdata$Exposure[i],
#                   plotdata$Cellline[i],
#                   plotdata$Antibody[i],
#                   plotdata$Cellcycle[i],
#                   'Norm by set',
#                   sep = ' ')) +
#     ggsave(filename = paste('figures/prelim',
#                             plotdata$Exposure[i],
#                             plotdata$Cellline[i],
#                             plotdata$Antibody[i],
#                             plotdata$Cellcycle[i],
#                             'Norm by set.pdf',
#                             sep = '_'),
#            width = 8.5, height = 5.5, units = "in")
# }


for (i in seq(length(unique(exposure)))){
  for (j in seq(length(unique(cellline)))){
    for (k in seq(length(unique(antibody)))){

      plotdata <- setnormdata[which(setnormdata$Exposure == unique(exposure)[i] &
                                       setnormdata$Cellline == unique(cellline)[j] &
                                       setnormdata$Antibody == unique(antibody)[k]),]
      if (nrow(plotdata) > 10){


      ggplot(plotdata, aes(FL, fill = Replicate)) +
        geom_density(alpha = alp, adjust = bw) +
        facet_grid(Dose~Timepoint) +
        geom_vline(xintercept = 1) +
        ggtitle(paste(plotdata$Exposure[i],
                      plotdata$Cellline[i],
                      plotdata$Antibody[i],
                      plotdata$Cellcycle[i],
                      'Norm by Z-score',
                      sep = ' ')) +
        ggsave(filename = paste('figures/zscore_norm/prelim',
                                plotdata$Exposure[i],
                                plotdata$Cellline[i],
                                plotdata$Antibody[i],
                                plotdata$Cellcycle[i],
                                'Norm by set zscore.pdf',
                                sep = '_'),
               width = 8.5, height = 5.5, units = "in")
      }
    }
  }
}








#
#
#
#
#
# for (i in seq(length(unique(exposure)))){
#   for (j in seq(length(unique(cellline)))){
#     for (k in seq(length(unique(antibody)))){
#
#   plotdata <- setnormdata2[which(setnormdata2$Exposure == unique(exposure)[i] &
#                                    setnormdata2$Cellline == unique(cellline)[j] &
#                                  setnormdata2$Antibody == unique(antibody)[k]),]
#
#   ggplot(plotdata, aes(FL, fill = Replicate)) +
#     geom_density(alpha = alp, adjust = bw) +
#     facet_grid(Dose~Timepoint) +
#     geom_vline(xintercept = 1) +
#     ggtitle(paste(plotdata$Exposure[i],
#                   plotdata$Cellline[i],
#                   plotdata$Antibody[i],
#                   plotdata$Cellcycle[i],
#                   'Norm by mean of sets',
#                   sep = ' ')) +
#     ggsave(filename = paste('figures/prelim2',
#                             plotdata$Exposure[i],
#                             plotdata$Cellline[i],
#                             plotdata$Antibody[i],
#                             plotdata$Cellcycle[i],
#                             'Norm by mean of set.pdf',
#                             sep = '_'),
#            width = 8.5, height = 5.5, units = "in")
#     }
#   }
# }
#
#
#
#












ggplot(setnormdata[which(setnormdata$Exposure == 'Ti300'),], aes(FL, fill = Replicate)) +
  geom_density(alpha = alp, adjust = bw) +
  facet_grid(Dose~Timepoint) +
  geom_vline(xintercept = 1) +
  ggtitle(paste(setnormdata$Exposure[1],
                setnormdata$Cellline[1],
                setnormdata$Antibody[1],
                setnormdata$Cellcycle[1],
                'Norm by set',
                sep = ' ')) +
  ggsave(filename = paste('figures/prelim',
                          setnormdata$Exposure[1],
                          setnormdata$Cellline[1],
                          setnormdata$Antibody[1],
                          setnormdata$Cellcycle[1],
                          'Norm by set.pdf',
                          sep = '_'),
         width = 8.5, height = 5.5, units = "in")




#
#
# # normalization by timepoint (mean of means of control sets)
# norms2 <- merge(log_alldata[], ddply(log_alldata[which(log_alldata$Dose == '0Gy'),],
#                                               .(Exposure, Timepoint, Cellline, Antibody, Cellcycle), summarize,
#                                               mean = round(mean(FL), 3)))
#
#
# setnormdata2 <- cbind(norms2[,1:7], FL = norms2$FL-norms2$mean+1)
#
# ggplot(setnormdata2[which(setnormdata2$Exposure == 'Fe1000'),], aes(FL, fill = Replicate)) +
#   geom_density(alpha = alp, adjust = bw) +
#   facet_grid(Dose~Timepoint) +
#   geom_vline(xintercept = 1) +
#   ggtitle(paste(setnormdata2$Exposure[1],
#                 setnormdata2$Cellline[1],
#                 setnormdata2$Antibody[1],
#                 setnormdata2$Cellcycle[1],
#                 'Norm by mean of sets',
#                 sep = ' '))
#
#
#
#
#
#





stats_data <- setstats[which(setstats$Timepoint == unique(timepoint)[2] &
                                setstats$Antibody == unique(antibody)[1]),]


boxplot(gmean ~ Dose:Exposure, data = stats_data)


fit <- aov(gmean ~ Dose+Exposure, data = stats_data)
summary(fit)

summary(glht(fit, linfct=mcp(Dose="Tukey", Exposure="Tukey")))

fit <- aov(mean ~ (Dose*Timepoint*Antibody)+(Exposure+Cellline), data = setstats)
summary(fit)

print(model.tables(fit,"means"),digits=3)

summary(glht(fit, linfct=mcp(Dose="Tukey")))



sig_threshold = 0.05
sig_results <- array(dim = c(200,6))
colnames(sig_results) <- c('Timepoint','Antibody','Cellline','Exposure','Dose','P-value')

for (i in seq(length(unique(exposure)))){
  for (j in seq(length(unique(cellline)))){
    for (k in seq(length(unique(antibody)))){
      for (l in seq(length(unique(timepoint))-1)){
        stats_data <- setstats[which(setstats$Timepoint == unique(timepoint)[l] &
                                       setstats$Antibody == unique(antibody)[k] &
                                       setstats$Cellline == unique(cellline)[j] &
                                       setstats$Exposure == unique(exposure)[i]),]
        if (nrow(stats_data) > 5){
          fit <- aov(gmean ~ Dose, data = stats_data)
          anova_results <- summary(glht(fit, linfct=mcp(Dose="Dunnett")))

          for (n in which(anova_results$test$pvalues < sig_threshold)){
            m <- min(which(is.na(sig_results)))
            sig_results[m,1] <- unique(timepoint)[l]
            sig_results[m,2] <- unique(antibody)[k]
            sig_results[m,3] <- unique(cellline)[j]
            sig_results[m,4] <- unique(exposure)[i]
            sig_results[m,5] <- names(anova_results$test$tstat)[n]
            sig_results[m,6] <- round(anova_results$test$pvalues[n],4)
          }
        }
      }
    }
  }
}

sig_results <- sig_results[-min(which(is.na(sig_results))):-nrow(sig_results),]
write.csv(sig_results, file = "sig_tables/Dose.csv")




sig_results <- array(dim = c(200,6))
colnames(sig_results) <- c('Timepoint','Antibody','Cellline','Exposure','Dose','P-value')

for (i in seq(length(unique(dose)))){
  for (j in seq(length(unique(cellline)))){
    for (k in seq(length(unique(antibody)))){
      for (l in seq(length(unique(timepoint))-1)){
        stats_data <- setstats[which(setstats$Timepoint == unique(timepoint)[l] &
                                       setstats$Antibody == unique(antibody)[k] &
                                       setstats$Cellline == unique(cellline)[j] &
                                       setstats$Dose == unique(dose)[i]),]
        if (nrow(stats_data) > 5){
          fit <- aov(gmean ~ Exposure, data = stats_data)
          anova_results <- summary(glht(fit, linfct=mcp(Exposure="Dunnett")))

          for (n in which(anova_results$test$pvalues < sig_threshold)){
            m <- min(which(is.na(sig_results)))
            sig_results[m,1] <- unique(timepoint)[l]
            sig_results[m,2] <- unique(antibody)[k]
            sig_results[m,3] <- unique(cellline)[j]
            sig_results[m,4] <- names(anova_results$test$tstat)[n]
            sig_results[m,5] <- unique(dose)[i]
            sig_results[m,6] <- round(anova_results$test$pvalues[n],4)
          }
        }
      }
    }
  }
}

sig_results <- sig_results[-min(which(is.na(sig_results))):-nrow(sig_results),]
write.csv(sig_results, file = "sig_tables/Exposure.csv")




sig_results <- array(dim = c(200,6))
colnames(sig_results) <- c('Timepoint','Antibody','Cellline','Exposure','Dose','P-value')

for (i in seq(length(unique(dose)))){
  for (j in seq(length(unique(exposure)))){
    for (k in seq(length(unique(antibody)))){
      for (l in seq(length(unique(timepoint))-1)){
        stats_data <- setstats[which(setstats$Timepoint == unique(timepoint)[l] &
                                       setstats$Antibody == unique(antibody)[k] &
                                       setstats$Exposure == unique(exposure)[j] &
                                       setstats$Dose == unique(dose)[i]),]
        if (nrow(stats_data) > 10){
          fit <- aov(gmean ~ Cellline, data = stats_data)
          anova_results <- summary(glht(fit, linfct=mcp(Cellline="Dunnett")))

          for (n in which(anova_results$test$pvalues < sig_threshold)){
            m <- min(which(is.na(sig_results)))
            sig_results[m,1] <- unique(timepoint)[l]
            sig_results[m,2] <- unique(antibody)[k]
            sig_results[m,3] <- names(anova_results$test$tstat)[n]
            sig_results[m,4] <- unique(exposure)[j]
            sig_results[m,5] <- unique(dose)[i]
            sig_results[m,6] <- round(anova_results$test$pvalues[n],4)
          }
        }
      }
    }
  }
}

sig_results <- sig_results[-min(which(is.na(sig_results))):-nrow(sig_results),]
write.csv(sig_results, file = "sig_tables/Cellline.csv")
















for (i in seq(length(unique(exposure)))){
  for (j in seq(length(unique(cellline)))){
    for (k in seq(length(unique(antibody)))){
      for (l in seq(length(unique(timepoint)))){
        for (m in seq(length(unique(dose)))){

          if (nrow(setstats) > 2){
          # comparison by dose
          stats_data <- setstats[which(setstats$Timepoint == unique(timepoint)[l] &
                                         setstats$Antibody == unique(antibody)[k] &
                                         setstats$Cellline == unique(cellline)[j] &
                                         setstats$Exposure == unique(exposure)[i]),]
          fit <- aov(gmean ~ Dose, data = stats_data)
          # summary(fit)
          print(c(unique(timepoint)[l],
                unique(antibody)[k],
                unique(cellline)[j],
                unique(exposure)[i]))
          print(summary(glht(fit, linfct=mcp(Dose="Dunnett"))))

          # comparison by exposure
          stats_data <- setstats[which(setstats$Timepoint == unique(timepoint)[l] &
                                         setstats$Antibody == unique(antibody)[k] &
                                         setstats$Cellline == unique(cellline)[j] &
                                         setstats$Dose == unique(dose)[m]),]
          fit <- aov(gmean ~ Exposure, data = stats_data)
          summary(fit)
          summary(glht(fit, linfct=mcp(Exposure="Tukey")))

          # comparison by cellline
          stats_data <- setstats[which(setstats$Timepoint == unique(timepoint)[l] &
                                         setstats$Antibody == unique(antibody)[k] &
                                         setstats$Exposure == unique(exposure)[i] &
                                         setstats$Dose == unique(dose)[m]),]
          fit <- aov(gmean ~ Cellline, data = stats_data)
          #summary(fit)


          print(summary(glht(fit, linfct=mcp(Cellline="Tukey"))))

          }
        }
      }
    }
  }
}


telo_data <- setstats[which((setstats$Timepoint == '24h' &
                              setstats$Antibody == 'pATF2') |
                              setstats$Antibody == 'Telo'),]


ggplot(telo_data, aes(x = Dose, y = gmean)) +
  geom_point(aes(color = Antibody)) +
  facet_grid(Cellline~Exposure)

# RE-LEVEL THE DOSE FACTOR

for (i in seq(length(unique(exposure)))){
  for (j in seq(length(unique(cellline)))){
    telo_data <- setstats[which(setstats$Antibody == 'Telo' &
                                setstats$Exposure == unique(exposure)[i] &
                                  setstats$Cellline == unique(cellline)[j]),]
    atf2_data <- setstats[which(setstats$Antibody == 'pATF2' &
                                  setstats$Timepoint == '24h' &
                                  setstats$Cellcycle == 'G1' &
                                  setstats$Exposure == unique(exposure)[i] &
                                  setstats$Cellline == unique(cellline)[j]),]
    catf2_data <- ddply(atf2_data, .(Cellline, Antibody, Timepoint, Exposure, Dose), summarize,
          cormean = mean(gmean))

    ctelo_data <- ddply(telo_data, .(Cellline, Antibody, Timepoint, Exposure, Dose), summarize,
                        cormean = mean(gmean))

    cor.test(catf2_data$cormean, ctelo_data$cormean)

  }
}

rbind(ctelo_data, catf2_data)

ggplot(rbind(ctelo_data, catf2_data), aes(x = Dose, y = cormean)) +
  geom_point(aes(color = Antibody)) +
  geom_line(aes(color = Antibody, group = Antibody))





        a








      }

      plotdata <- setnormdata[which(setnormdata$Exposure == unique(exposure)[i] &
                                      setnormdata$Cellline == unique(cellline)[j] &
                                      setnormdata$Antibody == unique(antibody)[k]),]
      if (nrow(plotdata) > 10){




























# still need to debug this part, but will normalize data based on control groups

norms <- merge(log_alldata, ddply(runs[which(runs$dose == 'CTRL'),],
                              .(antibody, cellline, timepoint, experiment), summarize,
                              mean = round(mean(log.mean), 3),
                              median = round(mean(log.median),3),
                              sd = round(sd(log.mean), 3)), by = c('antibody','cellline','timepoint','experiment'))

tdf <- norms
str(tdf)
tdf$fl <- (norms$fl-norms$median)+1

norm_runs <- ddply(tdf, .(antibody, cellline, timepoint, replicate, dose, experiment), summarize,
                   log.mean = round(mean(fl), 3),
                   sd = round(sd(fl), 3))
ctrl_means <- ddply(norm_runs[which(runs$dose == 'CTRL'),],
                    .(antibody, cellline, timepoint), summarize,
                    mean = round(mean(log.mean), 3),
                    sd = round(sd(log.mean), 3))









# create array for the control ids, assuming control is the first one in each replicate
for (i in seq(length(rdata))){
  if (dose[i] == "CTRL"){
    j = i
  }
  control[i] <- j
}

#---- Data processing ----
# take the logs of the data and the medians and means of the log data
logdata <- list()
logmedians <- list()
logmeans <- list()
for (i in seq(length(rdata))){
  logdata[[i]] <- signif(log(rdata[[i]]), digits = 6)
  #logmedians[[i]] <- median(logdata[[i]])
  logmeans[[i]] <- mean(logdata[[i]])
}

# make the raw and log dataframes
r_dfs <- list()
log_dfs <- list()

# make lists of individual data frames for the raw and log data
for (i in seq(length(logdata))){
  r_dfs[[i]] <- data.frame(fl = rdata[[i]], set = dataset_name[[i]],
                           antibody = antibody[i],
                           cellline = cellline[i],
                           timepoint = timepoint[i],
                           dose = dose[i],
                           replicate = replicate[i])
  log_dfs[[i]] <- data.frame(fl = logdata[[i]], set = dataset_name[[i]],
                             antibody = antibody[i],
                             cellline = cellline[i],
                             timepoint = timepoint[i],
                             dose = dose[i],
                             replicate = replicate[i])
}

# generate "total" dataframes for the raw and log data
tr_df <- r_dfs[[1]]
tlog_df <- log_dfs[[1]]

for (i in seq(2,length(log_dfs))){
  #tr_df <- rbind(tr_df, r_dfs[[i]])
  tlog_df <- rbind(tlog_df, log_dfs[[i]])

}

# Make a new factor column for the different experiments
expts <- array(dim = nrow(tlog_df))

sel = which(tlog_df$replicate == 'S1'
            | tlog_df$replicate == 'S2'
            | tlog_df$replicate == 'S3')
expts[sel] <- 'S'

sel = which(tlog_df$replicate == 'T1'
            | tlog_df$replicate == 'T2'
            | tlog_df$replicate == 'T3'
            | tlog_df$replicate == 'T4')
expts[sel] <- 'T'

sel = which(tlog_df$replicate == 'U1'
            | tlog_df$replicate == 'U2'
            | tlog_df$replicate == 'U3'
            | tlog_df$replicate == 'U4')
expts[sel] <- 'U'

tlog_df <- cbind(tlog_df, experiment = as.factor(expts))
rm(expts)

# make a data frame of run details
runs <- ddply(tlog_df, .(antibody, cellline, timepoint, replicate, dose, experiment), summarize,
              log.mean = round(mean(fl), 3),
              sd = round(sd(fl), 3))

log_ctrl_means <- ddply(runs[which(runs$dose == 'CTRL'),],
                        .(antibody, cellline, timepoint), summarize,
                        mean = round(mean(log.mean), 3),
                        sd = round(sd(log.mean), 3))

# make a static table of original runs, including cell counts
runlength <- array()
for (i in seq(1,length(logdata))){
  runlength[i] <- length(logdata[[i]])
}
runscounts <- cbind(runs, cellcount = runlength)

#---- Start looking at statistics and sets to toss ----

# calculate the mean and SD of all distributions - which are outside of normal shape?
mean(runs$sd)
runs$sd
## @knitr deviation_plots
ggplot(runs, aes(x = antibody, y = sd)) +
  geom_boxplot(aes(fill = cellline))

ggplot(runs, aes(x = antibody, y = sd)) +
  geom_jitter(aes(color = cellline)) +
  facet_grid(~cellline)

##
# plot_ly(runscounts, x = ~antibody, y = ~sd,
#         type = 'box',
#         color = ~cellline)


ggplot(runs, aes(sd)) +
  geom_histogram() +
  facet_grid(cellline~antibody)

ggplot(runs, aes(sd)) +
  geom_density() +
  facet_grid(cellline~antibody)

#---- SET REMOVAL ----

# bulk removal of sets
setremovals <- matrix(nrow = 0, ncol = 4)
setremovals <- rbind(setremovals, c('H2aX','SKBR3','24h 24h','T'))
setremovals <- rbind(setremovals, c('H2aX','SKBR3','24h','T'))
setremovals <- rbind(setremovals, c('H2aX','SKBR3','4h 24h','T'))
setremovals <- rbind(setremovals, c('H2aX','SKBR3','4h','U'))

setremovals <- rbind(setremovals, c('ATF2','SKBR3','24h','T'))
setremovals <- rbind(setremovals, c('ATF2','SKBR3','4h 24h','T'))

setremovals <- rbind(setremovals, c('H2aX','BT549','24h 24h','T'))
setremovals <- rbind(setremovals, c('H2aX','BT549','4h','T')) # SD among control means much higher than T

sd(runs[which(runs$antibody == 'H2aX' &
        runs$cellline == 'SKBR3' &
        runs$timepoint == '4h' &
        runs$dose == 'CTRL' &
        runs$experiment == 'T'),7])


for (r in seq(nrow(setremovals))){
  tlog_df <- tlog_df[-which(tlog_df$antibody == setremovals[r,1] &
                              tlog_df$cellline == setremovals[r,2] &
                              tlog_df$timepoint == setremovals[r,3] &
                              tlog_df$experiment == setremovals[r,4]),]
}


# build a table of runs to remove, based on e.g. cell count, SD
removals <- matrix(nrow = 0, ncol = 5)
removals <- rbind(removals, c('ATF2','HCC','24h','T3','HD')) # SD over .5
removals <- rbind(removals, c('ATF2','BT549','4h','S2','HD')) # SD over .5
removals <- rbind(removals, c('ATF2','BT549','4h','S2','LD')) # SD over .5
removals <- rbind(removals, c('H2aX','SKBR3','4h 24h','U3','HD')) # not a normal distrubtion
removals <- rbind(removals, c('H2aX','BT549','4h','U4','CTRL')) # very low cell count

#removals <- rbind(removals, c('H2aX','SKBR3','4h','U2','CTRL'))
#removals <- rbind(removals, c('ATF2','HCC','24h','S1','HD'))
#removals <- rbind(removals, c('ATF2','HCC','24h','S1','LD'))
#removals <- rbind(removals, c('ATF2','HCC','24h','S2','LD'))
#removals <- rbind(removals, c('H2aX','HCC','24h 24h','S1','CTRL'))
#removals <- rbind(removals, c('H2aX','HCC','24h 24h','S2','CTRL'))

# remove sets from tlog_df, rebuild runs & log_ctrl_means
for (r in seq(nrow(removals))){
  tlog_df <- tlog_df[-which(tlog_df$antibody == removals[r,1] &
                              tlog_df$cellline == removals[r,2] &
                              tlog_df$timepoint == removals[r,3] &
                              tlog_df$replicate == removals[r,4] &
                              tlog_df$dose == removals[r,5]),]
}

runs <- ddply(tlog_df, .(antibody, cellline, timepoint, replicate, dose, experiment), summarize,
              log.mean = round(mean(fl), 3),
              log.median = round(median(fl),3),
              sd = round(sd(fl), 3))

log_ctrl_means <- ddply(runs[which(runs$dose == 'CTRL'),],
                        .(antibody, cellline, timepoint), summarize,
                        mean = round(mean(log.mean), 3),
                        median = round(mean(log.median),3),
                        sd = round(sd(log.mean), 3))

# inspect the data for systematic shifts
# plotting variables
pAb = 'H2aX'
pcell = 'SKBR3'

abcellplot(pAb, pcell)


## SKBR3 + ATF2 + 4h + Experiment T has a systematic shift. Correcting it, keeping variance within set.
## BT549 + ATF2 + 4h + Experiment S has a systematic shift. Will correct it too.
# HCC + ATF2 + 24h 24h / 4h / 4h 24h + Experiment S has a systematic shift.
# SKBR3 + H2aX + 4h + Experiment T has a systematic shift.

# build a table of sets with systematic shifts compared to others that should be corrected
fixes <- matrix(nrow = 0, ncol = 4)
fixes <- rbind(fixes, c('ATF2','SKBR3','4h','T'))
fixes <- rbind(fixes, c('H2aX','SKBR3','4h','T')) # prob a cell count issue
# fixes <- rbind(fixes, c('H2aX','SKBR3','24h','T'))
# fixes <- rbind(fixes, c('H2aX','SKBR3','4h 24h','T'))
# fixes <- rbind(fixes, c('H2aX','SKBR3','24h 24h','T'))
# fixes <- rbind(fixes, c('ATF2','BT549','4h','S'))
# fixes <- rbind(fixes, c('H2aX','HCC','4h','T'))
# fixes <- rbind(fixes, c('H2aX','HCC','24h','T'))
# fixes <- rbind(fixes, c('ATF2','HCC','24h 24h','T'))
# fixes <- rbind(fixes, c('ATF2','HCC','4h 24h','T'))

fixlog_df <- tlog_df

for (i in seq(nrow(fixes))){
  fixAb = fixes[i,1]
  fixCell = fixes[i,2]
  fixTime = fixes[i,3]
  fixExp = fixes[i,4]

  goodmean <- mean(runs$log.mean[which(runs$cellline == fixCell &
                                         runs$antibody == fixAb &
                                         runs$timepoint == fixTime &
                                         runs$experiment != fixExp)])
  setmean <- mean(runs$log.mean[which(runs$cellline == fixCell &
                                        runs$antibody == fixAb &
                                        runs$timepoint == fixTime &
                                        runs$experiment == fixExp)])

  # now need to fix tlog_df, runs, log_mean_means, log_ctrl_means,
  fixFactor = goodmean - setmean

  fixlog_df$fl[which(tlog_df$antibody == fixAb &
                     tlog_df$cellline == fixCell &
                     tlog_df$timepoint == fixTime &
                     tlog_df$experiment == fixExp)] <-
    tlog_df$fl[which(tlog_df$antibody == fixAb &
                       tlog_df$cellline == fixCell &
                       tlog_df$timepoint == fixTime &
                       tlog_df$experiment == fixExp)] + fixFactor
}

fixruns <- ddply(tlog_df, .(antibody, cellline, timepoint, replicate, dose, experiment), summarize,
              log.mean = round(mean(fl), 3),
              sd = round(sd(fl), 3))

fixlog_ctrl_means <- ddply(runs[which(runs$dose == 'CTRL'),],
                        .(antibody, cellline, timepoint), summarize,
                        mean = round(mean(log.mean), 3),
                        sd = round(sd(log.mean), 3))

# check to make sure it worked by plotting
abcellplot(fixAb, fixCell)






mean(tlog_df$fl[which(tlog_df$antibody == 'ATF2' & tlog_df$dose == 'CTRL' &
                        tlog_df$experiment == 'U')])




# still need to debug this part, but will normalize data based on control groups

norms <- merge(tlog_df, ddply(runs[which(runs$dose == 'CTRL'),],
                           .(antibody, cellline, timepoint, experiment), summarize,
                           mean = round(mean(log.mean), 3),
                           median = round(mean(log.median),3),
                           sd = round(sd(log.mean), 3)), by = c('antibody','cellline','timepoint','experiment'))

tdf <- norms
str(tdf)
tdf$fl <- (norms$fl-norms$median)+1

norm_runs <- ddply(tdf, .(antibody, cellline, timepoint, replicate, dose, experiment), summarize,
                           log.mean = round(mean(fl), 3),
                           sd = round(sd(fl), 3))
ctrl_means <- ddply(norm_runs[which(runs$dose == 'CTRL'),],
                        .(antibody, cellline, timepoint), summarize,
                        mean = round(mean(log.mean), 3),
                        sd = round(sd(log.mean), 3))


pAb = 'ATF2'
pcell = 'SKBR3'
tabcellplot(pAb, pcell)






normdata <- list()
for (i in seq(length(logdata))){
  normdata[[i]] <- 1 + logdata[[i]] - runs_norms$normfactor[[i]]
}

# make lists of individual data frames for the normalized data
for (i in seq(length(logdata))){
  dfs[[i]] <- data.frame(fl = normdata[[i]], set = dataset_name[[i]],
                         antibody = antibody[i],
                         cellline = cellline[i],
                         timepoint = timepoint[i],
                         dose = dose[i],
                         replicate = replicate[i],
                         experiment = expts2[i])
}

tdf <- dfs[[1]]
for (i in seq(2,length(dfs))){
  tdf <- rbind(tdf, dfs[[i]])
}


# normalize to 1 (or standardize) the data by taking 1 + (x - median(control set for x))/mad(control set for x)

# normfactors <- array()
#
# for (i in seq(length(logdata))){
#   logmads[[i]] <- mad(logdata[[i]])
#   normdata[[i]] <- 1 + (logdata[[i]] - logmedians[[control[[i]]]])/logmads[[control[[i]]]]
#   normfactors[i] <- median(normdata[[control[[i]]]])
# }

# need to remove sets which don't make sense here, before making means of them
# calculate the mean and standard deviation of the means of alllllll data sets
# for a given antibody
h2ax_mean <- mean(runs$log.mean[which(runs$antibody == 'H2aX')])
atf2_mean <- mean(runs$log.mean[which(runs$antibody == 'ATF2')])
# h2ax_median <- median(runs$log.mean[which(runs$antibody == 'H2aX')])
# atf2_median <- median(runs$log.mean[which(runs$antibody == 'ATF2')])
h2ax_sd <- sd(runs$log.mean[which(runs$antibody == 'H2aX')])
atf2_sd <- sd(runs$log.mean[which(runs$antibody == 'ATF2')])

# repeat above, but only for control groups
h2ax_ctrl_mean <- mean(runs$log.mean[which(runs$antibody == 'H2aX' & runs$dose == 'CTRL')])
atf2_ctrl_mean <- mean(runs$log.mean[which(runs$antibody == 'ATF2' & runs$dose == 'CTRL')])
# h2ax_ctrl_median <- median(runs$log.mean[which(runs$antibody == 'H2aX' & runs$dose == 'CTRL')])
# atf2_ctrl_median <- median(runs$log.mean[which(runs$antibody == 'ATF2' & runs$dose == 'CTRL')])
h2ax_ctrl_sd <- sd(runs$log.mean[which(runs$antibody == 'H2aX' & runs$dose == 'CTRL')])
atf2_ctrl_sd <- sd(runs$log.mean[which(runs$antibody == 'ATF2' & runs$dose == 'CTRL')])

dixon.test(runs$log.mean[which(runs$antibody == 'H2aX' & runs$dose == 'CTRL')])
dixon.test(runs$log.mean[which(runs$antibody == 'ATF2' & runs$dose == 'CTRL')])

#---- Statistical description and analysis ----

# this part is totally not working right now, need to evaluate HOW to do stats testing
# define the sample size n
n = 4000

Dose = "HD"
Cell = "SKBR3"
Time = "4h 24h"
Ab = "H2aX"


indexer <- which(tlog_df$dose == Dose &
                   tlog_df$cellline == Cell &
                   tlog_df$timepoint == Time &
                   tlog_df$antibody == Ab &
                   tlog_df$replicate == 'U3')

ref_indexer <- which(tlog_df$dose == Dose &
                       tlog_df$cellline == Cell &
                       tlog_df$timepoint == Time &
                       tlog_df$antibody == Ab
                     #                  & tlog_df$replicate == 'S1'
)

fitdata <- sample_n(tlog_df[indexer,], n, replace = TRUE)
refdata <- sample_n(tlog_df[ref_indexer,], n)

disdata <- fitdist(fitdata$fl, 'norm')
refdisdata <- fitdist(refdata$fl, 'norm')
plot(disdata)
plot(refdisdata)

# Kolmogorov-Smirnov test for normality (D closer to 0 is more normal / the same distribution)
ks.test(unique(refdisdata$data), 'pnorm')
ks.test(unique(disdata$data), unique(refdisdata$data))

#densityplot(fitdata$fl)
#scores(disdata$data)
#plot(ecdf(disdata$data))
kruskal.test(fl ~ replicate, data = fitdata)
#fit <- aov(fl ~ timepoint, data = tdf[which(tdf$dose == 'CTRL' & tdf$cellline == "BT549"),])
fit <- aov(fl ~ replicate, data = fitdata)

summary(fit)
summary(glht(fit, linfct=mcp(replicate = "Tukey")))

summary(tr_df$replicate[indexer])

subdata <- tdf$fl[indexer]
subdata2 <- tdf$fl[indexer2]

# distribution analysis
qqnorm(subdata); qqline(subdata)
#qqplot(subdata, 'pnorm')
plotdist(subdata, histo = TRUE, demp = TRUE)
descdist(ja3$data, boot = 100)

ja <- fitdist(subdata, "norm")
ja2 <- fitdist(subdata2, "norm")
ja3 <- fitdist(tr_df$fl[indexer], 'lnorm')
denscomp(ja3)
cdfcomp(ja3)

plot(ja3)

gofstat(ja3, fitnames = "norm")

# Kolmogorov-Smirnov test for normality (D closer to 0 is more normal)
plot(ecdf(disdata$data))
ks.test(unique(disdata$data), 'pnorm')
ks.test(unique(ja3$data), unique(subdata2))

# Wilcoxon Rank Sum Test
wilcox.test(subdata, subdata2)
kruskal.test(fl ~ dose, data = tdf[indexer,])

str(subdata)

# T-test

t.test(x = tdf$fl[which(tdf$dose == "HD" &
                          tdf$cellline == "HCC" &
                          tdf$timepoint == "24h" &
                          tdf$antibody == 'H2aX')],
       y = tdf$fl[which(tdf$dose == "LD" &
                          tdf$cellline == "HCC" &
                          tdf$timepoint == "24h" &
                          tdf$antibody == 'H2aX')],
       conf.level = 0.95)

# ANOVA

# ==== PLOT THE DATA ====

# ---- Plot the raw data ----
figprefix <- 'Figures/merged_expts/raw/'

ggplot(tr_df[which(tr_df$dose == 'CTRL' & tr_df$antibody == 'ATF2'), ], aes(fl, fill = replicate, by = replicate)) +
  geom_density(alpha = alp,  adjust = bw) +
  facet_grid(timepoint ~ cellline) +
  ggsave(filename = paste(figprefix, 'controls_ATF2.pdf', sep = ""),
         width = 8.5, height = 5.5, units = "in")

ggplot(tr_df[which(tr_df$dose == 'CTRL' & tr_df$antibody == 'H2aX'), ], aes(fl, fill = replicate, by = replicate)) +
  geom_density(alpha = alp,  adjust = bw) +
  facet_grid(timepoint ~ cellline) +
  xlim(4e4,3e5) +
  ggtitle("raw controls H2aX") +
  ggsave(filename = paste(figprefix, 'controls_H2aX.pdf', sep = ""),
         width = 8.5, height = 5.5, units = "in")


ggplot(tr_df[which(tr_df$antibody == 'ATF2' & tr_df$cellline == 'BT549'), ], aes(fl, fill = replicate)) +
  geom_density(alpha = alp,  adjust = bw) +
  facet_grid(timepoint ~ dose) +
  ggsave(filename = paste(figprefix, 'BT549_ATF2.pdf', sep = ""),
         width = 8.5, height = 5.5, units = "in")

ggplot(tr_df[which(tr_df$antibody == 'H2aX' & tr_df$cellline == 'BT549'), ], aes(fl, fill = replicate)) +
  geom_density(alpha = alp,  adjust = bw) +
  facet_grid(timepoint ~ dose) +
  ggsave(filename = paste(figprefix, 'BT549_H2aX.pdf', sep = ""),
         width = 8.5, height = 5.5, units = "in")


ggplot(tr_df[which(tr_df$antibody == 'ATF2' & tr_df$cellline == 'SKBR3'), ], aes(fl, fill = replicate)) +
  geom_density(alpha = alp,  adjust = bw) +
  facet_grid(timepoint ~ dose) +
  ggsave(filename = paste(figprefix, 'SKBR3_ATF2.pdf', sep = ""),
         width = 8.5, height = 5.5, units = "in")

ggplot(tr_df[which(tr_df$antibody == 'H2aX' & tr_df$cellline == 'SKBR3'), ], aes(fl, fill = replicate)) +
  geom_density(alpha = alp,  adjust = bw) +
  facet_grid(timepoint ~ dose) +
  ggsave(filename = paste(figprefix, 'SKBR3_H2aX.pdf', sep = ""),
         width = 8.5, height = 5.5, units = "in")

ggplot(tr_df[which(tr_df$antibody == 'ATF2' & tr_df$cellline == 'HCC'), ], aes(fl, fill = replicate)) +
  geom_density(alpha = alp,  adjust = bw) +
  facet_grid(timepoint ~ dose) +
  ggsave(filename = paste(figprefix, 'HCC_ATF2.pdf', sep = ""),
         width = 8.5, height = 5.5, units = "in")

ggplot(tr_df[which(tr_df$antibody == 'H2aX' & tr_df$cellline == 'HCC'), ], aes(fl, fill = replicate)) +
  geom_density(alpha = alp,  adjust = bw) +
  facet_grid(timepoint ~ dose) +
  xlim(4e4,3e5)
ggsave(filename = paste(figprefix, 'HCC_H2aX.pdf', sep = ""),
       width = 8.5, height = 5.5, units = "in")



ggplot(tr_df[which(tr_df$dose == 'LD' & tr_df$antibody == 'ATF2'), ], aes(fl, fill = replicate, by = replicate)) +
  geom_density(alpha = alp,  adjust = bw) +
  facet_grid(timepoint ~ cellline)

ggplot(tr_df[which(tr_df$dose == 'LD' & tr_df$antibody == 'H2aX'), ], aes(fl, fill = replicate, by = replicate)) +
  geom_density(alpha = alp,  adjust = bw) +
  facet_grid(timepoint ~ cellline) +
  xlim(4e4,1.7e5)



ggplot(tr_df[which(tr_df$dose == 'HD' & tr_df$antibody == 'ATF2'), ], aes(fl, fill = replicate, by = replicate)) +
  geom_density(alpha = alp,  adjust = bw) +
  facet_grid(timepoint ~ cellline)

ggplot(tr_df[which(tr_df$dose == 'HD' & tr_df$antibody == 'H2aX'), ], aes(fl, fill = replicate, by = replicate)) +
  geom_density(alpha = alp,  adjust = bw) +
  facet_grid(timepoint ~ cellline) +
  xlim(4e4,1.7e5)


# ---- Plot the log data ----

figprefix <- 'Figures/merged_expts/log/'

ggplot(tlog_df[which(tlog_df$dose == 'CTRL' & tlog_df$antibody == 'ATF2'), ], aes(fl, fill = replicate, by = replicate)) +
  geom_density(alpha = alp,  adjust = bw) +
  facet_grid(timepoint ~ cellline) +
  ggsave(filename = paste(figprefix, 'controls_ATF2.pdf', sep = ""),
         width = 8.5, height = 5.5, units = "in")



ggplot(tlog_df[which(tlog_df$dose == 'CTRL' & tlog_df$antibody == 'H2aX'), ], aes(fl, fill = replicate, by = replicate)) +
  geom_density(alpha = alp,  adjust = bw) +
  facet_grid(timepoint ~ cellline) +
  ggtitle('log congrols H2aX') +
  ggsave(filename = paste(figprefix, 'controls_H2aX.pdf', sep = ""),
         width = 8.5, height = 5.5, units = "in")


ggplot(tlog_df[which(tlog_df$antibody == 'ATF2' & tlog_df$cellline == 'BT549'), ], aes(fl, fill = replicate)) +
  geom_density(alpha = alp,  adjust = bw) +
  facet_grid(timepoint ~ dose) +
  ggsave(filename = paste(figprefix, 'BT549_ATF2.pdf', sep = ""),
         width = 8.5, height = 5.5, units = "in")

ggplot(tlog_df[which(tlog_df$antibody == 'H2aX' & tlog_df$cellline == 'BT549'), ], aes(fl, fill = replicate)) +
  geom_density(alpha = alp,  adjust = bw) +
  facet_grid(timepoint ~ dose) +
  ggsave(filename = paste(figprefix, 'BT549_H2aX.pdf', sep = ""),
         width = 8.5, height = 5.5, units = "in")


ggplot(tlog_df[which(tlog_df$antibody == 'ATF2' & tlog_df$cellline == 'SKBR3'), ], aes(fl, fill = replicate)) +
  geom_density(alpha = alp,  adjust = bw) +
  facet_grid(timepoint ~ dose) +
  ggsave(filename = paste(figprefix, 'SKBR3_ATF2.pdf', sep = ""),
         width = 8.5, height = 5.5, units = "in")

ggplot(tlog_df[which(tlog_df$antibody == 'H2aX' & tlog_df$cellline == 'SKBR3'), ], aes(fl, fill = replicate)) +
  geom_density(alpha = alp,  adjust = bw) +
  facet_grid(timepoint ~ dose) +
  ggsave(filename = paste(figprefix, 'SKBR3_H2aX.pdf', sep = ""),
         width = 8.5, height = 5.5, units = "in")

ggplot(tlog_df[which(tlog_df$antibody == 'ATF2' & tlog_df$cellline == 'HCC'), ], aes(fl, fill = replicate)) +
  geom_density(alpha = alp,  adjust = bw) +
  facet_grid(timepoint ~ dose) +
  ggsave(filename = paste(figprefix, 'HCC_ATF2.pdf', sep = ""),
         width = 8.5, height = 5.5, units = "in")

ggplot(tlog_df[which(tlog_df$antibody == 'H2aX' & tlog_df$cellline == 'HCC'), ], aes(fl, fill = replicate)) +
  geom_density(alpha = alp,  adjust = bw) +
  facet_grid(timepoint ~ dose) +
  ggsave(filename = paste(figprefix, 'HCC_H2aX.pdf', sep = ""),
         width = 8.5, height = 5.5, units = "in")







# ggplot(data = pdf, aes_string("fl", fill = pfill), alpha = alp, adjust = bw) +
#   geom_density()
#
#
# ggplot(tlog_df[which(tlog_df$dose == "CTRL"),], aes(fl, fill = cellline, by = replicate)) +
#   geom_density(alpha = alp,  adjust = bw) +
#   facet_grid(timepoint ~ dose)



# plot the grouped and individual control groups
# ggplot(tlog_df[which(tlog_df$dose == 'CTRL'), ], aes(fl, fill = cellline)) +
#   geom_density(alpha = alp,  adjust = bw) +
#   facet_grid(timepoint ~ antibody) +
#   geom_vline(xintercept = as.vector(ctrl_abs_mean))
#
# ggplot(tlog_df[which(tlog_df$dose == 'CTRL'), ], aes(fl, fill = cellline, by = replicate)) +
#   geom_density(alpha = alp,  adjust = bw) +
#   facet_grid(timepoint ~ dose) +
#   geom_vline(xintercept = as.vector(ctrl_abs_mean)) #+
#   # ggsave(filename = 'Figures/controls_logspace.pdf',
#   #        width = 8.5, height = 5.5, units = "in")


# ---- Plot the normalized data ----

ggplot(tdf[which(tdf$dose == 'CTRL'), ], aes(fl, fill = cellline, by = replicate)) +
  geom_density(alpha = alp,  adjust = bw) +
  facet_grid(timepoint ~ antibody) +
  geom_vline(xintercept = 1) +
  ggsave(filename = paste(figprefix, 'controls_normalized.pdf', sep = ""),
         width = 8.5, height = 5.5, units = "in")

ggplot(tdf[which(tdf$dose == 'CTRL'), ], aes(fl, fill = cellline)) +
  geom_density(alpha = alp,  adjust = bw) +
  facet_grid(timepoint ~ antibody) +
  geom_vline(xintercept = 1) +
  ggsave(filename = paste(figprefix,'controls_normalized_grouped.pdf', sep = ""),
         width = 8.5, height = 5.5, units = "in")

ggplot(tdf[which(tdf$antibody == "H2aX"),], aes(fl, fill = cellline, by = replicate)) +
  geom_density(alpha = alp,  adjust = bw) +
  facet_grid(timepoint ~ dose) +
  geom_vline(xintercept = 1) +
  ggtitle('H2aX') +
  #xlim(-8,10) +
  ggsave(filename = paste(figprefix,'H2aX_dose_by_timepoint.pdf', sep = ""),
         width = 8.5, height = 5.5, units = "in")

ggplot(tdf[which(tdf$antibody == "ATF2"),], aes(fl, fill = cellline, by = replicate)) +
  geom_density(alpha = alp,  adjust = bw) +
  facet_grid(timepoint ~ dose) +
  geom_vline(xintercept = 1) +
  ggsave(filename = paste(figprefix,'ATF2_dose_by_timepoint.pdf', sep = ""),
         width = 8.5, height = 5.5, units = "in")

ggplot(tdf[which(tdf$antibody == "H2aX"),], aes(fl, fill = cellline)) +
  geom_density(alpha = alp,  adjust = bw) +
  facet_grid(timepoint ~ dose) +
  geom_vline(xintercept = 1) +
  ggsave(filename = paste(figprefix,'H2aX_dose_by_timepoint_averaged.pdf', sep = ""),
         width = 8.5, height = 5.5, units = "in")

ggplot(tdf[which(tdf$antibody == "ATF2"),], aes(fl, fill = cellline)) +
  geom_density(alpha = alp,  adjust = bw) +
  facet_grid(timepoint ~ dose) +
  geom_vline(xintercept = 1) +
  ggsave(filename = paste(figprefix,'ATF2_dose_by_timepoint_averaged.pdf', sep = ""),
         width = 8.5, height = 5.5, units = "in")


ggplot(tdf, aes(x = dose, y = fl, fill = cellline, by = experiment, color = experiment)) +
  geom_boxplot(notch = TRUE, notchwidth = 0.25, outlier.color = NULL, position = "dodge") +
  facet_grid(antibody~timepoint) +
  geom_hline(yintercept = 1) +
  scale_x_discrete(limits = levels(tdf$dose)[c(1,3,2)]) +
  ggsave(filename = paste(figprefix, 'boxplot_doses_timepoint_by_antibody.pdf', sep = ""),
         width = 8.5, height = 5.5, units = "in")

# ggplot(tlog_df[which(tlog_df$dose == "CTRL"),], aes(x = dose, y = fl, fill = cellline, by = replicate, color = replicate)) +
#   geom_boxplot(notch = TRUE, notchwidth = 0.25, outlier.color = NULL, position = "dodge") +
#   facet_grid(antibody~timepoint) +
#   ggsave(filename = paste(figprefix, 'boxplot_doses_timepoint_by_antibody_unnormalized_controls.pdf', sep = ""),
#          width = 8.5, height = 5.5, units = "in")

ggplot(tdf, aes(x = dose, y = fl, fill = cellline)) +
  geom_boxplot(notch = TRUE, notchwidth = 0.25, outlier.color = NULL, position = "dodge") +
  facet_grid(antibody~timepoint) +
  geom_hline(yintercept = 1) +
  scale_x_discrete(limits = levels(tdf$dose)[c(1,3,2)]) +
  ggsave(filename = paste(figprefix, 'boxplot_doses_timepoint_by_antibody_averaged.pdf', sep = ""),
         width = 8.5, height = 5.5, units = "in")

ggplot(tdf, aes(x = cellline, y = fl, fill = dose)) +
  geom_boxplot(notch = TRUE, notchwidth = 0.25, outlier.color = NULL, position = "dodge") +
  facet_grid(antibody~timepoint) +
  geom_hline(yintercept = 1) +
  # scale_x_discrete(limits = levels(tdf$dose)[c(1,3,2)]) +
  ggsave(filename = paste(figprefix, 'boxplot_celllines_timepoint_by_antibody_averaged.pdf', sep = ""),
         width = 8.5, height = 5.5, units = "in")


ggplot(tdf, aes(x = cellline, y = fl, fill = dose)) +
  geom_violin(adjust = bw) +
  facet_grid(antibody~timepoint) +
  geom_hline(yintercept = 1) +
  #scale_x_discrete(limits = rev(levels(tdf$dose))[1:2]) +
  ggsave(filename = paste(figprefix, 'violin_celllines_timepoint_by_antibody_averaged.pdf', sep = ""),
         width = 8.5, height = 5.5, units = "in")





ggplot(tdf[which(tdf$cellline == "SKBR3"),], aes(x = dose, y = fl, fill = experiment)) +
  geom_boxplot(notch = TRUE, notchwidth = 0.25, outlier.color = NULL, position = "dodge") +
  facet_grid(antibody ~ timepoint) +
  geom_hline(yintercept = 1)


ggplot(tdf[which(tdf$cellline == "SKBR3"),], aes(x = replicate, y = fl, fill = dose)) +
  geom_boxplot(notch = TRUE, notchwidth = 0.25, outlier.color = NULL, position = "dodge") +
  facet_grid(antibody ~ timepoint) +
  geom_hline(yintercept = 1)


ggplot(skbr3counts, aes(x = replicate, y = cellcount)) +
  geom_col(position = 'dodge') +
  facet_grid(antibody~timepoint) +
  geom_hline(yintercept = 5000)




